- job:
    name: windows-tests
    description: 'Main Jenkins job responsible for orchestrating tasks required to run GPII Windows tests'
    project-type: multijob
    build_timeout: 180
    node: h-0005.tor1.incd.ca
    properties:
      # Required by the GitHub PR builder plugin.
      - github:
          url: https://github.com/GPII/windows/
    triggers:
      - gh-pr-builder
    scm:
      - gh-pr-scm
    wrappers:
      - timeout:
          # Abort after these many minutes
          timeout: 180
          # Mark the build as failed
          fail: true
    builders:
      # Each parent multijob builder passes the Jenkins WORKSPACE environment
      # variable to its child job as a parameter so that a common Git working
      # directory can be used.
      - multijob:
          name: windows-create-vm
          condition: COMPLETED
          projects:
            - name: windows-create-vm
              predefined-parameters: parent_workspace=$WORKSPACE
      - multijob:
          name: windows-provision-vm
          condition: COMPLETED
          projects:
            - name: windows-provision-1909
              predefined-parameters: parent_workspace=$WORKSPACE
            - name: windows-provision-ltsc
              predefined-parameters: parent_workspace=$WORKSPACE
      - multijob:
          name: windows-code-analysis
          condition: COMPLETED
          projects:
            - name: windows-code-analysis
              predefined-parameters: parent_workspace=$WORKSPACE
      - multijob:
          name: windows-unit-tests-1909
          condition: COMPLETED
          projects:
            - name: windows-unit-tests-1909
              predefined-parameters: parent_workspace=$WORKSPACE
            - name: windows-unit-tests-ltsc
              predefined-parameters: parent_workspace=$WORKSPACE
      - multijob:
          name: windows-acceptance-tests-1909
          condition: COMPLETED
          projects:
            - name: windows-acceptance-tests-1909
              predefined-parameters: parent_workspace=$WORKSPACE
            - name: windows-acceptance-tests-ltsc
              predefined-parameters: parent_workspace=$WORKSPACE
      - multijob:
          name: windows-delete-vm
          condition: SUCCESSFUL
          projects:
            - name: windows-delete-vm
              predefined-parameters: parent_workspace=$WORKSPACE
    publishers:
      - archive:
          artifacts: "reports/**, coverage/**"
          allow-empty: true
          only-if-success: true

- job:
    name: windows-create-vm
    description: 'Job responsible for creating a test VM'
    node: h-0005.tor1.incd.ca
    workspace: $parent_workspace
    builders:
      # Setting BUILD_ID for vagrant to make sure Jenkins process tree killer doesn't kill the VM
      # before the next job is started
      - shell: DISPLAY=:0 BUILD_ID=gpii-windows vagrant up --no-provision --provider virtualbox

- job:
    name: windows-provision-1909
    description: 'Job responsible for provisionin the VM 1909'
    node: h-0005.tor1.incd.ca
    workspace: $parent_workspace
    builders:
      - shell: vagrant provision 1909
    publishers:
      - email:
          recipients: ci@lists.gpii.net

- job:
    name: windows-provision-LTSC
    description: 'Job responsible for provisionin the VM LTSC'
    node: h-0005.tor1.incd.ca
    workspace: $parent_workspace
    builders:
      - shell: vagrant provision LTSC
    publishers:
      - email:
          recipients: ci@lists.gpii.net

- job:
    name: windows-code-analysis
    description: 'GPII Windows code analysis'
    node: h-0005.tor1.incd.ca
    workspace: $parent_workspace
    builders:
      - shell: vagrant winrm LTSC -c "do.ps1 -c 'grunt lint'"
    publishers:
      - email:
          recipients: ci@lists.gpii.net

- job:
    name: windows-unit-tests-ltsc
    description: 'GPII Windows unit tests in LTSC Windows 10'
    node: h-0005.tor1.incd.ca
    workspace: $parent_workspace
    builders:
      - shell: vagrant winrm LTSC -c "do.ps1 -c 'npm run test:unit'"
    publishers:
      - email:
          recipients: ci@lists.gpii.net
    wrappers:
      - timeout:
          timeout: 90
          fail: true

- job:
    name: windows-acceptance-tests-ltsc
    description: 'GPII Windows acceptance tests in LTSC Windows 10'
    node: h-0005.tor1.incd.ca
    workspace: $parent_workspace
    builders:
      - shell: vagrant winrm LTSC -c "do.ps1 -c 'npm run test:acceptance'"
    publishers:
      - email:
          recipients: ci@lists.gpii.net
    wrappers:
      - timeout:
          timeout: 90
          fail: true

- job:
    name: windows-unit-tests-1909
    description: 'GPII Windows unit tests in 1909 version of Windows 10'
    node: h-0005.tor1.incd.ca
    workspace: $parent_workspace
    builders:
      - shell: vagrant winrm 1909 -c "do.ps1 -c 'npm run test:unit'"
    publishers:
      - email:
          recipients: ci@lists.gpii.net
    wrappers:
      - timeout:
          timeout: 90
          fail: true

- job:
    name: windows-acceptance-tests-1909
    description: 'GPII Windows acceptance tests in 1909 version of Windows 10'
    node: h-0005.tor1.incd.ca
    workspace: $parent_workspace
    builders:
      - shell: vagrant winrm 1909 -c "do.ps1 -c 'npm run test:acceptance'"
    publishers:
      - email:
          recipients: ci@lists.gpii.net
    wrappers:
      - timeout:
          timeout: 90
          fail: true

- job:
    name: windows-delete-vm
    description: 'Job responsible for deleting the test VM'
    node: h-0005.tor1.incd.ca
    workspace: $parent_workspace
    builders:
      - shell: vagrant halt -f && sleep 5 && vagrant destroy -f
